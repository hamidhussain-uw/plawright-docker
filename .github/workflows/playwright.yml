name: Playwright Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch: # Allows manual triggering

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Test against multiple browsers
        browser: [chromium, firefox]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      run: docker compose build
    
    - name: Run Playwright tests
      run: docker compose run --rm playwright npm test --project=${{ matrix.browser }}
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report-${{ matrix.browser }}
        path: |
          playwright-report/
          test-results/
        retention-days: 30
    
    - name: Upload screenshots
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots-${{ matrix.browser }}
        path: screenshots/
        retention-days: 7
    
    - name: Upload videos
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: videos-${{ matrix.browser }}
        path: videos/
        retention-days: 7

  # Optional: Test report job that runs after all browsers complete
  # Note: HTML reports are already generated during test runs and uploaded as artifacts
  # This job can be used to download and view combined reports if needed
  report:
    if: always()
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: all-artifacts
    
    - name: Note about reports
      run: |
        echo "HTML reports are available in the artifacts from each browser test run."
        echo "Download the 'playwright-report-<browser>' artifacts to view reports."
